برای هدایت ترافیک از خارج از خوشه Kubernetes به یک آدرس IP داخلی یا یک سرویس خاص در داخل خوشه، از یک **Ingress** یا **Service** همراه با **LoadBalancer** یا **NodePort** در Kubernetes استفاده می‌کنیم. در اینجا توضیح می‌دهیم که چگونه می‌توانید این کار را انجام دهید.

### سناریوهای مختلف برای هدایت ترافیک به سرویس داخلی:

1. **استفاده از Service با نوع LoadBalancer**
2. **استفاده از Ingress Controller**
3. **استفاده از Service با نوع NodePort**

### 1. **استفاده از Service با نوع LoadBalancer**

اگر نیاز دارید که ترافیک ورودی از خارج از خوشه به یک سرویس خاص در داخل خوشه هدایت شود، بهترین روش استفاده از سرویس نوع **LoadBalancer** است. این نوع سرویس به‌طور خودکار یک IP عمومی (Public IP) برای سرویس شما تخصیص می‌دهد و به ترافیک ورودی از اینترنت اجازه می‌دهد تا به سرویس شما در داخل خوشه هدایت شود.

#### مثال: تعریف یک سرویس از نوع LoadBalancer

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: my-app  # نام لابلای پادهایی که باید از این سرویس استفاده کنند
  ports:
    - protocol: TCP
      port: 80          # پورت داخلی که به سرویس داده می‌شود
      targetPort: 8080   # پورت واقعی که پاد به آن گوش می‌دهد
  type: LoadBalancer
```

### نحوه عملکرد:

1. **LoadBalancer**: زمانی که این سرویس ایجاد می‌شود، Kubernetes با استفاده از کنترل‌کننده‌های بارگذاری (Load Balancer Controller) به‌طور خودکار یک IP عمومی به سرویس شما اختصاص می‌دهد. این IP عمومی به ترافیک ورودی اجازه می‌دهد تا به پادهای درون خوشه هدایت شود.
   
2. **پورت‌ها**: درخواست‌هایی که به این IP عمومی می‌آیند به پورت 80 این سرویس هدایت می‌شوند و سپس به پادهایی که پورت 8080 را گوش می‌دهند، ارسال می‌شود.

3. **راه‌اندازی سرویس**: برای اجرای این سرویس، باید یک Load Balancer در محیط شما پیکربندی شده باشد (این معمولا در محیط‌های ابری مانند AWS، GCP یا Azure به‌طور خودکار پشتیبانی می‌شود).

### 2. **استفاده از Ingress Controller**

اگر می‌خواهید ترافیک ورودی از اینترنت را به یک یا چند سرویس داخلی هدایت کنید، می‌توانید از **Ingress** و **Ingress Controller** استفاده کنید. Ingress یک شیء API در Kubernetes است که به شما امکان می‌دهد قوانین مسیر‌یابی برای ترافیک HTTP(S) را بر اساس URL و دامین‌ها تنظیم کنید.

#### گام‌های لازم برای استفاده از Ingress:
1. **نصب Ingress Controller**: برای استفاده از Ingress در Kubernetes، ابتدا باید یک **Ingress Controller** نصب کنید. Ingress Controller، مسئول پردازش درخواست‌های ورودی به خوشه شما است.

   یکی از مشهورترین Ingress Controller ها، **NGINX Ingress Controller** است که به‌راحتی می‌توان آن را نصب کرد:

   ```bash
   kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
   ```

2. **تعریف یک سرویس Ingress**: بعد از نصب Ingress Controller، شما باید یک شیء **Ingress** ایجاد کنید که قوانین ترافیک ورودی را به سرویس‌های مختلف هدایت کند.

#### مثال: تعریف یک Ingress برای هدایت ترافیک به سرویس‌های مختلف

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: my-app.example.com  # نام دامنه یا آدرس IP خارجی
    http:
      paths:
      - path: /path1
        pathType: Prefix
        backend:
          service:
            name: my-service-1
            port:
              number: 80
      - path: /path2
        pathType: Prefix
        backend:
          service:
            name: my-service-2
            port:
              number: 80
```

### نحوه عملکرد:

1. **Ingress**: در این مثال، درخواست‌هایی که به دامنه `my-app.example.com` وارد می‌شوند، طبق مسیر مشخص‌شده (`/path1` یا `/path2`)، به سرویس‌های مختلف هدایت می‌شوند.
   - درخواست‌های `/path1` به `my-service-1` هدایت می‌شوند.
   - درخواست‌های `/path2` به `my-service-2` هدایت می‌شوند.

2. **Ingress Controller**: مسئول است که ترافیک HTTP یا HTTPS را دریافت کرده و به مسیرهای داخلی و سرویس‌های مشخص‌شده هدایت کند.

3. **Rewrite Target**: با استفاده از انوتیشن `nginx.ingress.kubernetes.io/rewrite-target: /` می‌توانید مسیر درخواست‌ها را به روت سرویس تغییر دهید (این کار معمولاً برای حذف یا تغییر پیشوند URL انجام می‌شود).

### 3. **استفاده از Service با نوع NodePort**

اگر به دلایلی نمی‌خواهید از **LoadBalancer** استفاده کنید، می‌توانید از سرویس نوع **NodePort** استفاده کنید. این سرویس ترافیک ورودی را از تمام نودهای خوشه دریافت می‌کند و آن را به پادهای داخل خوشه هدایت می‌کند.

#### مثال: تعریف یک سرویس از نوع NodePort

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80          # پورت داخلی سرویس
      targetPort: 8080   # پورت واقعی پاد
      nodePort: 30001    # پورت در نود که به سرویس متصل است
  type: NodePort
```

### نحوه عملکرد:

1. **NodePort**: در این حالت، یک پورت در هر نود خوشه (در اینجا پورت `30001`) برای سرویس باز می‌شود. درخواست‌های ورودی به این پورت از خارج از خوشه به پادها هدایت می‌شوند.
   
2. **پورت‌ها**: وقتی کاربری به پورت `30001` از هر نود خوشه شما دسترسی پیدا کند، این درخواست‌ها به سرویس شما در پورت 80 هدایت می‌شوند و سپس به پادهای خاص هدایت می‌شوند.

### نکات مهم:

- **LoadBalancer**: این گزینه به طور خودکار یک IP عمومی برای سرویس شما ایجاد می‌کند و معمولاً برای محیط‌های ابری مناسب است.
- **NodePort**: این روش ممکن است برای محیط‌هایی که در آنها LoadBalancer وجود ندارد مناسب باشد، ولی نیاز به دسترسی به هر نود خوشه از خارج دارد.
- **Ingress**: این روش برای هدایت ترافیک HTTP/HTTPS به سرویس‌های مختلف بر اساس قوانین URL یا دامنه است و بسیار مناسب برای مدیریت ترافیک ورودی است.

### نتیجه‌گیری:

برای هدایت ترافیک از خارج از خوشه Kubernetes به یک سرویس داخلی، می‌توانید از روش‌های مختلفی مانند **LoadBalancer**، **NodePort** یا **Ingress** استفاده کنید. انتخاب روش بستگی به نیازهای شما دارد:
- اگر به **IP عمومی** نیاز دارید، از **LoadBalancer** استفاده کنید.
- اگر نیاز دارید ترافیک HTTP/HTTPS را بر اساس مسیر یا دامنه هدایت کنید، از **Ingress** استفاده کنید.
- اگر به **دسترسی به پورت‌های خاص نود** نیاز دارید، از **NodePort** استفاده کنید.
